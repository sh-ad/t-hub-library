<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>T-Hub · Библиотека</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <meta name="theme-color" content="#FFDD2D" />
  <style>
    :root{
      --accent:#FFDD2D; --accent-text:#111;
      --bg-dark:#0B0B0B; --bg-light:#F8F8F8;
      --fg-dark:#F2F2F2; --fg-light:#111;
      --muted-dark:#9CA3AF; --muted-light:#4B5563;
      --card-dark:#121212; --card-light:#FFF;
      --border-dark:#1F1F1F; --border-light:#E5E7EB;
      --ok:#22C55E; --err:#E11D48;
    }
    @media (prefers-color-scheme: dark){
      :root{--bg:var(--bg-dark);--fg:var(--fg-dark);--muted:var(--muted-dark);--card:var(--card-dark);--border:var(--border-dark);}
    }
    @media (prefers-color-scheme: light){
      :root{--bg:var(--bg-light);--fg:var(--fg-light);--muted:var(--muted-light);--card:var(--card-light);--border:var(--border-light);}
    }
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:
        radial-gradient(900px 500px at 15% -10%, rgba(255,221,45,.18), transparent 60%),
        radial-gradient(900px 500px at 115% 120%, rgba(255,221,45,.14), transparent 60%),
        var(--bg);
      color:var(--fg);display:flex;align-items:center;justify-content:center;
      min-height:100vh;padding:24px;
    }
    .shell{width:100%;max-width:720px}
    .brand{display:flex;align-items:center;gap:10px;margin:0 auto 14px;width:max-content}
    .brand-badge{width:36px;height:36px;border-radius:8px;background:var(--accent);
      color:var(--accent-text);display:grid;place-items:center;font-weight:900;
      box-shadow:0 8px 24px rgba(255,221,45,.35)}
    .brand-title{font-weight:800}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;
      padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.12)}
    h1{margin:0 0 8px;font-size:24px}
    p{margin:6px 0;color:var(--muted)}
    .code{margin:16px 0;font-size:34px;font-weight:800;letter-spacing:.02em;
      padding:14px 16px;border-radius:12px;background:rgba(148,163,184,.10);
      border:1px dashed var(--border);text-align:center;word-break:break-all}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-top:16px}
    input[type=text]{flex:1 1 220px;padding:12px 14px;border-radius:10px;
      border:1px solid var(--border);background:transparent;color:var(--fg);
      font-size:18px;text-align:center}
    button{padding:12px 16px;border:0;border-radius:10px;font-size:16px;cursor:pointer}
    .primary{background:var(--accent);color:var(--accent-text)}
    .ghost{background:transparent;border:1px solid var(--border);color:var(--fg)}
    .hint{margin-top:12px;font-size:14px;color:var(--muted)}
    .ok{color:var(--ok)} .err{color:var(--err)}
    .footer{margin-top:16px;font-size:13px;color:var(--muted)}
    a{color:var(--accent);text-decoration:none}
    .hidden{display:none}

    .toggle{display:flex;gap:8px;background:rgba(148,163,184,.10);border:1px solid var(--border);
      border-radius:12px;padding:6px;align-items:center;justify-content:center;flex-wrap:wrap}
    .toggle button{background:transparent;border:1px solid transparent;padding:8px 12px;border-radius:8px}
    .toggle button[aria-pressed="true"]{background:var(--accent);color:var(--accent-text)}
  </style>
</head>
<body>
  <div class="shell">
    <div class="brand">
      <div class="brand-badge">T</div>
      <div class="brand-title">T-Hub·Библиотека</div>
    </div>

    <main class="card" role="main" aria-labelledby="title">
      <h1 id="title">Взять или вернуть книгу</h1>
      <p>Выберите действие, введите код и откройте чат библиотеки в Time.</p>

      <div class="toggle" role="tablist" aria-label="Действие">
        <button id="actTake"  role="tab" aria-selected="true"  aria-pressed="true" >Взять</button>
        <button id="actReturn"role="tab" aria-selected="false" aria-pressed="false">Вернуть</button>
      </div>

      <div id="detectedWrap" class="hidden">
        <div class="code" id="codeVisual" aria-live="polite">—</div>
      </div>

      <div class="row">
        <input type="text" id="codeInput" placeholder="Код книги (например, 1234)" inputmode="numeric" />
        <button id="copyOpenBtn" class="primary">Скопировать и открыть Time</button>
        <button id="copyBtn" class="ghost">Только скопировать</button>
      </div>

      <p id="status" class="hint" aria-live="polite"></p>
      <p class="footer">
        Если приложение не открылось — используйте веб-чат:
        <a href="https://time.tbank.ru/tinkoff/messages/@t-hub-library" target="_blank">@t-hub-library</a>
      </p>
    </main>
  </div>

  <script>
    const TIME_DEEPLINK = "timeapp://time.tbank.ru/tinkoff/messages/@t-hub-library";
    const TIME_WEB = "https://time.tbank.ru/tinkoff/messages/@t-hub-library";

    const qs = k => new URLSearchParams(location.search).get(k);
    const b64url = s => {try{s=s.replace(/-/g,'+').replace(/_/g,'/');while(s.length%4)s+='=';return atob(s);}catch(e){return null;}};
    const norm = s => (s||'').toString().trim().replace(/\s+/g,'').toUpperCase();
    const normCode = s => norm(s).replace(/\D/g,'').slice(0,4);

    function fromHash(){
      const h=location.hash.replace(/^#/,'');
      if(!h)return{};
      const sp=new URLSearchParams(h.includes('=')?h:'code='+h);
      return { code: sp.get('code')||sp.get('c')||sp.get('k')||'', action: sp.get('action')||sp.get('a')||'' };
    }
    function extractInitial(){
      const qCode = qs('code')||qs('c')||qs('k');
      const qAction = (qs('action')||qs('a')||'').toLowerCase();
      const h = fromHash();
      const p = qs('payload')||qs('p');
      let code = qCode || h.code || '';
      let action = (qAction || h.action || '').toLowerCase();
      if(p){
        const raw=b64url(p);
        if(raw){ try{ const o=JSON.parse(raw); code = code || o.code||o.book_id||o.id||''; action = action || (o.action||'').toLowerCase(); }catch(e){} }
      }
      if(!code){
        const entries=Array.from(new URLSearchParams(location.search).entries());
        if(entries.length===1&&entries[0][0]===''&&entries[0][1]) code = entries[0][1];
      }
      return { code, action };
    }

    async function copy(text){
      try{ await navigator.clipboard.writeText(text); return true; }
      catch(e){
        const t=document.createElement('textarea');
        t.value=text;t.style.position='fixed';t.style.opacity='0';
        document.body.appendChild(t);t.select();
        const ok=document.execCommand('copy');document.body.removeChild(t);
        return ok;
      }
    }

    const codeInput   = document.getElementById('codeInput');
    const codeVisual  = document.getElementById('codeVisual');
    const detectedWrap= document.getElementById('detectedWrap');
    const statusEl    = document.getElementById('status');
    const copyOpenBtn = document.getElementById('copyOpenBtn');
    const copyBtn     = document.getElementById('copyBtn');
    const actTakeBtn  = document.getElementById('actTake');
    const actReturnBtn= document.getElementById('actReturn');

    let currentAction = 'take';

    function setAction(a){
      currentAction = (a==='return'?'return':'take');
      actTakeBtn.setAttribute('aria-pressed', String(currentAction==='take'));
      actReturnBtn.setAttribute('aria-pressed', String(currentAction==='return'));
      actTakeBtn.setAttribute('aria-selected', String(currentAction==='take'));
      actReturnBtn.setAttribute('aria-selected', String(currentAction==='return'));
      const verbRU = currentAction==='take' ? 'взять' : 'вернуть';
      statusEl.textContent = `Готово ${verbRU}. Введите код и нажмите кнопку.`;
    }

    const init = extractInitial();
    let code = normCode(init.code);
    if(code){
      codeInput.value=code;
      codeVisual.textContent=code;
      detectedWrap.classList.remove('hidden');
      statusEl.textContent='Код найден. Нажмите кнопку — мы скопируем команду и откроем чат.';
    }else{
      statusEl.textContent='Введите код книги вручную.';
    }
    setAction(init.action);

    codeInput.addEventListener('input',()=>{
      const v=normCode(codeInput.value);
      codeInput.value=v;
      codeVisual.textContent=v||'—';
      detectedWrap.classList.toggle('hidden',!v);
    });

    actTakeBtn.addEventListener('click',()=>setAction('take'));
    actReturnBtn.addEventListener('click',()=>setAction('return'));

    async function handleCopy(openAfter){
      const val=normCode(codeInput.value);
      if(!val){statusEl.innerHTML='<span class="err">Введите 4-значный код книги</span>';return;}
      const command=`/library ${currentAction} ${val}`;
      const ok=await copy(command);
      statusEl.innerHTML=ok?`<span class="ok">Команда <code>${command}</code> скопирована</span>`:
        '<span class="err">Не удалось скопировать</span>';
      if(openAfter){
        setTimeout(()=>{window.location.href=TIME_DEEPLINK;},200);
        setTimeout(()=>{try{window.open(TIME_WEB,'_blank','noopener');}catch(e){}},900);
      }
    }

    copyBtn.addEventListener('click',()=>handleCopy(false));
    copyOpenBtn.addEventListener('click',()=>handleCopy(true));
  </script>
</body>
</html>
